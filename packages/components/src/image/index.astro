---
import type { CloudflareImageTransformOptions, ImageProps } from './types'
import { serializeOptions } from './utils'

export type Props = ImageProps

const {
  src,
  alt,
  widths = [480, 768, 1024, 1400],
  sizes = '(min-width: 1024px) 50vw, 100vw',
  quality = 85,
  format = 'auto',
  transformOptions = {},
  deliveryBase = '/cdn-cgi/image',
  allowedDomains = [],
  loading = 'lazy',
  decoding = 'async',
  ...rest
} = Astro.props as ImageProps

const isAbsoluteSrc = typeof src === 'string' && (src.startsWith('http://') || src.startsWith('https://'))
const parsedSrc = isAbsoluteSrc ? new URL(src) : null
const isDomainAllowed = !allowedDomains.length || (parsedSrc && allowedDomains.includes(parsedSrc.hostname))

const baseFromSrc = parsedSrc ? parsedSrc.origin : ''
const normalizeBaseRaw = deliveryBase.endsWith('/') ? deliveryBase.slice(0, -1) : deliveryBase
const normalizeBase =
  isAbsoluteSrc && normalizeBaseRaw.startsWith('/')
    ? `${baseFromSrc}${normalizeBaseRaw}`
    : normalizeBaseRaw
const normalizeSource = parsedSrc
  ? `${parsedSrc.pathname}${parsedSrc.search}`
  : src?.replace(/^\/+/, '')

const baseOptions: CloudflareImageTransformOptions = {
  quality,
  format,
  ...transformOptions,
}

const buildUrl = (width: number) => {
  const optionsWithWidth: CloudflareImageTransformOptions = {
    ...baseOptions,
    width,
  }

  const optionsString = serializeOptions(optionsWithWidth)
  const sourceSegment = normalizeSource?.replace(/^\/+/, '') ?? ''
  return `${normalizeBase}/${optionsString}/${sourceSegment}`
}

const effectiveWidths = widths.length ? widths : [1400]
const shouldTransform = Boolean(src) && isDomainAllowed
const srcset = shouldTransform ? effectiveWidths.map((width) => `${buildUrl(width)} ${width}w`).join(', ') : undefined
const fallbackSrc = shouldTransform ? buildUrl(effectiveWidths[effectiveWidths.length - 1]!) : src
---

<img
  src={fallbackSrc}
  srcset={srcset}
  sizes={sizes}
  alt={alt}
  loading={loading}
  decoding={decoding}
  {...rest}
/>

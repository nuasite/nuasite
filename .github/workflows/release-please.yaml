name: Release Please

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        if: ${{ steps.release.outputs.pr }}

      - name: Update lockfile
        if: ${{ steps.release.outputs.pr }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ fromJSON(steps.release.outputs.pr).number }}"
          PR_BRANCH="release-please--branches--main"

          gh pr checkout "$PR_NUMBER" --repo "${{ github.repository }}"

          # Set up bun and regenerate lockfile
          curl -fsSL https://bun.sh/install | bash
          export PATH="$HOME/.bun/bin:$PATH"
          bun install

          # Commit updated lockfile if changed
          if git diff --quiet bun.lock; then
            echo "Lockfile unchanged, skipping commit."
          else
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add bun.lock
            git commit -m "chore: update bun.lock"
            git push origin "HEAD:$PR_BRANCH"
          fi

  publish:
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created == 'true' }}
    uses: ./.github/workflows/publish.yaml
    with:
      tag_name: ${{ needs.release-please.outputs.tag_name }}
